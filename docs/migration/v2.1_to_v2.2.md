# Migration Guide: v2.1 to v2.2

## Overview

Bashmenu v2.2 introduces significant improvements in architecture, performance, and features. This guide will help you migrate from v2.1 to v2.2.

## Breaking Changes

### 1. Configuration System

**v2.1:**
```bash
# config/config.conf
LOG_FILE=/tmp/bashmenu.log
PLUGIN_DIR=/home/user/plugins
```

**v2.2:**
```bash
# .bashmenu.env
BASHMENU_LOG_DIR=/var/log/bashmenu
BASHMENU_PLUGINS_DIR=~/.bashmenu/plugins
```

**Action Required:** Run migration script (see below)

### 2. Directory Structure

**Changed:**
- `src/menu_legacy.sh` → Removed
- `config.conf` → `.bashmenu.env`
- Modules reorganized into `src/{core,menu,scripts,features,ui}`

**Action Required:** Use new paths when sourcing modules

### 3. Module Imports

**v2.1:**
```bash
source src/menu_core.sh
source src/script_loader.sh
```

**v2.2:**
```bash
source src/menu/core.sh
source src/scripts/loader.sh
```

**Action Required:** Update custom scripts that source modules

## New Features

### 1. Cache System
- Automatic caching of script lists
- TTL-based invalidation
- Performance improvement: 50-70%

### 2. Search System
- Real-time incremental search
- Search by name, description, tags
- Interactive UI with keyboard navigation

### 3. Favorites System
- Persistent favorites in JSON
- Export/import functionality
- Visual indicators (⭐)

### 4. Hooks System
- Event-driven hooks
- 5 hook types: pre_execute, post_execute, on_error, on_load, on_exit
- Priority-based execution

### 5. Audit System
- JSONL audit logging
- Automatic rotation
- Export to CSV/JSON

### 6. Lazy Loading
- Modules loaded on-demand
- Faster startup time
- Reduced memory footprint

## Migration Process

### Automatic Migration (Recommended)

```bash
# 1. Backup current installation
bash migrate.sh --dry-run

# 2. Run migration
bash migrate.sh

# 3. Verify
bash scripts/validate-paths.sh
```

### Manual Migration

#### Step 1: Backup

```bash
cp -r /opt/bashmenu /opt/bashmenu.backup.$(date +%Y%m%d)
cp ~/.bashmenu ~/.bashmenu.backup.$(date +%Y%m%d)
```

#### Step 2: Update Configuration

Create `.bashmenu.env`:

```bash
# System-wide: /opt/bashmenu/etc/.bashmenu.env
# User-level: ~/.bashmenu/.bashmenu.env

BASHMENU_HOME=/opt/bashmenu
BASHMENU_USER_DIR=~/.bashmenu
BASHMENU_PLUGINS_DIR=~/.bashmenu/plugins
BASHMENU_LOG_DIR=/var/log/bashmenu
BASHMENU_CACHE_DIR=~/.bashmenu/cache
BASHMENU_THEME=modern
BASHMENU_LOG_LEVEL=INFO
BASHMENU_ENABLE_CACHE=true
BASHMENU_CACHE_TTL=3600
BASHMENU_ENABLE_COLORS=true
BASHMENU_ENABLE_PLUGINS=true
BASHMENU_ENABLE_HISTORY=true
BASHMENU_DEBUG_MODE=false
BASHMENU_STRICT_MODE=false
```

#### Step 3: Update Paths

Convert absolute paths to relative:

```bash
# Old
/home/user/GIT/Bashmenu/plugins/script.sh

# New
${BASHMENU_PLUGINS_DIR}/script.sh
```

#### Step 4: Update Custom Scripts

If you have custom scripts that source bashmenu modules:

```bash
# Old
source /opt/bashmenu/src/menu_core.sh

# New
source /opt/bashmenu/src/menu/core.sh
```

#### Step 5: Test

```bash
# Run bashmenu
bash /opt/bashmenu/bashmenu

# Check logs
tail -f /var/log/bashmenu/bashmenu.log
```

## Rollback

If you encounter issues:

```bash
# Automatic rollback
bash migrate.sh --rollback

# Manual rollback
rm -rf /opt/bashmenu
mv /opt/bashmenu.backup.YYYYMMDD /opt/bashmenu
```

## Configuration Mapping

| v2.1 | v2.2 | Notes |
|------|------|-------|
| `LOG_FILE` | `BASHMENU_LOG_DIR` | Now a directory |
| `PLUGIN_DIR` | `BASHMENU_PLUGINS_DIR` | User-specific |
| `DEFAULT_THEME` | `BASHMENU_THEME` | Same values |
| `UI_MODE` | Removed | Auto-detected |

## Feature Comparison

| Feature | v2.1 | v2.2 |
|---------|------|------|
| Configuration | config.conf | .bashmenu.env |
| Cache | No | Yes |
| Search | Basic | Advanced |
| Favorites | No | Yes |
| Hooks | No | Yes |
| Audit | No | Yes |
| Lazy Loading | No | Yes |
| Performance | Baseline | +50-70% |
| Tests | <20% | >65% |

## Troubleshooting

### Issue: "Config file not found"

**Solution:**
```bash
# Create default config
cp .bashmenu.env.example ~/.bashmenu/.bashmenu.env
```

### Issue: "Scripts not found"

**Solution:**
```bash
# Update plugin directory
export BASHMENU_PLUGINS_DIR=~/.bashmenu/plugins
mkdir -p "$BASHMENU_PLUGINS_DIR"
```

### Issue: "Permission denied"

**Solution:**
```bash
# Fix permissions
sudo chown -R $USER:$USER ~/.bashmenu
chmod 755 ~/.bashmenu
```

### Issue: "Cache not working"

**Solution:**
```bash
# Enable cache
echo "BASHMENU_ENABLE_CACHE=true" >> ~/.bashmenu/.bashmenu.env

# Clear cache
rm -rf ~/.bashmenu/cache/*
```

## Performance Improvements

### Startup Time

- v2.1: ~2.5s
- v2.2: ~1.0s (with cache)
- Improvement: 60%

### Search Performance

- v2.1: ~500ms (100 scripts)
- v2.2: ~50ms (100 scripts)
- Improvement: 90%

### Memory Usage

- v2.1: ~15MB
- v2.2: ~8MB (with lazy loading)
- Improvement: 47%

## New Commands

```bash
# Search
Press '/' in menu

# Favorites
Press 'F' to toggle favorite
Press 'f' to view favorites

# Help
Press '?' for help
Press 'h' for tutorial

# Dashboard
Press 'd' for dashboard
```

## API Changes

### Removed Functions

- `load_legacy_config()` - Use `load_configuration()`
- `scan_scripts_legacy()` - Use cache system

### New Functions

- `cache_init()`, `cache_get()`, `cache_set()`
- `search_init()`, `search_incremental()`
- `favorites_init()`, `favorites_add()`, `favorites_remove()`
- `hooks_init()`, `register_hook()`, `execute_hooks()`
- `audit_init()`, `audit_log_event()`, `audit_query()`
- `lazy_init()`, `lazy_load_module()`

## Support

- Documentation: `/opt/bashmenu/docs/`
- Issues: Report via your issue tracker
- Logs: `/var/log/bashmenu/bashmenu.log`

## Checklist

- [ ] Backup current installation
- [ ] Run migration script
- [ ] Verify configuration
- [ ] Test basic functionality
- [ ] Test custom scripts
- [ ] Update documentation
- [ ] Train users on new features

---

**Version:** 2.2  
**Last Updated:** 2026-02-21  
**Migration Script:** `migrate.sh`
