<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetterAgents Memory Dashboard</title>
    <!-- 
        BetterAgents Memory Dashboard
        Author: JEMAVI (Jesus Maria Villalobos)
        Website: https://jemavi.co
        Description: Computer Engineer & IT Consultant
        Specialties: Cloud Solutions, AI, IT Consulting
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-gradient-start: #f8fafc;
            --bg-gradient-end: #e8f0fe;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --accent-start: #3b82f6;
            --accent-mid: #2563eb;
            --accent-end: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --hover-bg: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        [data-theme="dark"] {
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --accent-start: #60a5fa;
            --accent-mid: #3b82f6;
            --accent-end: #2563eb;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --info: #60a5fa;
            --hover-bg: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 24px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header { 
            background: var(--card-bg); 
            padding: 40px 48px; 
            border-radius: 20px; 
            margin-bottom: 32px; 
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
        }
        .header-left { flex: 1; min-width: 300px; }
        .header h1 { 
            font-size: 2.25em; 
            font-weight: 800;
            color: var(--text-primary); 
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            letter-spacing: -0.02em;
        }
        .logo { 
            font-size: 1.5em;
            filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.3));
        }
        .subtitle { 
            color: var(--text-secondary); 
            font-size: 1em;
            font-weight: 500;
            line-height: 1.5;
        }
        .header-right { display: flex; gap: 12px; align-items: center; }
        .theme-toggle {
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        .theme-toggle:hover { 
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-mid) 100%);
            border-color: var(--accent-start);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .theme-toggle:active {
            transform: translateY(0);
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn span {
            position: relative;
            z-index: 1;
        }
        .btn-refresh { 
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }
        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-mid) 100%);
            border-color: var(--accent-start);
            color: white;
        }
        .btn:active {
            transform: translateY(0);
        }
        .search-container { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: 20px; 
            margin-bottom: 32px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        .search-wrapper {
            position: relative;
            display: block;
            flex: 1 1 auto;
            min-width: 250px;
            max-width: 400px;
        }
        .search { 
            width: 100%;
            padding: 16px 50px; 
            background: var(--hover-bg); 
            border: 2px solid var(--border-color); 
            border-radius: 12px; 
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
            height: 52px;
        }
        .search:focus { 
            outline: none; 
            border-color: var(--accent-start); 
            background: var(--card-bg);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), var(--shadow);
            transform: translateY(-1px);
        }
        .search::placeholder {
            color: var(--text-tertiary);
        }
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            pointer-events: none;
            font-size: 1.2em;
        }
        .search-clear {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--text-tertiary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }
        .search-clear:hover {
            background: var(--error);
            transform: translateY(-50%) scale(1.15);
        }
        .search-clear:active {
            transform: translateY(-50%) scale(0.95);
        }
        .search-clear.visible {
            display: flex;
        }
        .tabs { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap;
        }
        .tab { 
            background: var(--card-bg); 
            border: 2px solid var(--border-color);
            color: var(--text-secondary); 
            padding: 16px 20px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            height: 52px;
        }
        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
            transition: height 0.3s ease;
        }
        .tab:hover { 
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
            border-color: var(--accent-start);
        }
        .tab.active { 
            background: var(--card-bg);
            color: var(--accent-start);
            border-color: var(--accent-start);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            font-weight: 700;
        }
        .tab.active span {
            color: var(--accent-start);
        }
        .tab.active::before {
            height: 4px;
        }
        .tab-badge {
            background: var(--accent-start);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 700;
            min-width: 22px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: inline-block;
        }
        .tab.active .tab-badge {
            background: var(--accent-start);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            border-color: var(--accent-start);
        }
        .tab:not(.active) .tab-badge {
            background: var(--hover-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .tab:hover:not(.active) .tab-badge {
            background: var(--accent-start);
            color: white;
            border-color: var(--accent-start);
        }

        /* Context Cards */
        .context-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .context-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .context-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
            transition: width 0.3s ease;
        }
        .context-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-start);
        }
        .context-card:hover::before {
            width: 8px;
        }
        .context-card-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            display: block;
        }
        .context-card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .context-card-description {
            color: var(--text-secondary);
            font-size: 0.95em;
            line-height: 1.5;
        }
        .context-card-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--accent-start);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
        }

        .content { 
            background: var(--card-bg); 
            padding: 40px; 
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            min-height: 400px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .section-title {
            font-size: 1.75em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 3px solid transparent;
            background: linear-gradient(to right, var(--border-color), var(--border-color)) no-repeat bottom;
            background-size: 100% 3px;
            display: flex;
            align-items: center;
            gap: 14px;
            letter-spacing: -0.02em;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
            border-radius: 2px;
        }
        .entry { 
            background: var(--card-bg);
            padding: 28px; 
            margin-bottom: 20px; 
            border-radius: 16px; 
            border-left: 5px solid var(--accent-start);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            border-left-width: 5px;
            position: relative;
            overflow: hidden;
        }
        .entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
            transition: width 0.4s ease;
        }
        .entry:hover::before {
            width: 8px;
        }
        .entry:hover { 
            transform: translateX(6px) translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-start);
        }
        .entry-header { 
            display: flex; 
            gap: 18px; 
            margin-bottom: 16px; 
            flex-wrap: wrap; 
            font-size: 0.85em; 
            color: var(--text-tertiary);
            font-weight: 600;
        }
        .entry-header span {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--hover-bg);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .entry-header span:hover {
            background: var(--accent-start);
            color: white;
            transform: scale(1.05);
        }
        .entry-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 14px;
            line-height: 1.4;
            letter-spacing: -0.01em;
        }
        .entry-content {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 0.98em;
        }
        .entry-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        .entry-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .entry-content li {
            margin: 4px 0;
            line-height: 1.5;
        }

        /* Context Cards */
        .context-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .context-card:hover {
            border-color: var(--primary-color);
        }
        .context-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .context-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-card-toggle {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        .context-card-toggle.expanded {
            transform: rotate(180deg);
        }
        .context-card-content {
            display: none;
            padding-top: 12px;
            margin-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        .context-card-content.show {
            display: block;
        }
        .context-item {
            margin-bottom: 12px;
        }
        .context-item:last-child {
            margin-bottom: 0;
        }
        .context-item-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 13px;
        }
        .context-item-value {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
        }
        .context-item-value ul {
            margin: 4px 0;
            padding-left: 20px;
        }
        .context-item-value li {
            margin: 4px 0;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }
        .badge-high {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        .badge-medium {
            background: rgba(251, 146, 60, 0.1);
            color: #fb923c;
        }
        .badge-low {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .entry-tags { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .tag {
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-mid) 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            border: 1px solid transparent;
        }
        .tag:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .empty-state { 
            text-align: center; 
            padding: 80px 20px; 
            color: var(--text-secondary);
            animation: fadeIn 0.6s ease-out;
        }
        .empty-icon { 
            font-size: 5em; 
            margin-bottom: 24px; 
            opacity: 0.4;
            filter: grayscale(0.3);
        }
        .empty-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }
        .empty-text { 
            font-size: 1em;
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto;
        }
        .loading { 
            text-align: center; 
            padding: 60px 40px; 
            color: var(--text-secondary);
        }
        .spinner {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--accent-start);
            border-right: 5px solid var(--accent-mid);
            border-bottom: 5px solid var(--accent-end);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 24px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            body { padding: 16px; }
            .header { 
                padding: 28px 24px; 
                border-radius: 16px;
            }
            .header h1 { 
                font-size: 1.75em;
                gap: 12px;
            }
            .logo { font-size: 1.3em; }
            .subtitle { font-size: 0.9em; }
            .stats { 
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .stat-card {
                padding: 28px 24px;
            }
            .content { 
                padding: 24px 20px;
                border-radius: 16px;
            }
            .section-title {
                font-size: 1.4em;
            }
            .entry {
                padding: 20px;
                border-radius: 12px;
            }
            .tabs {
                gap: 8px;
            }
            .tab {
                padding: 12px 20px;
                font-size: 0.9em;
            }
            .search-container {
                padding: 16px;
            }
            .search {
                padding: 14px 20px;
                padding-left: 40px;
            }
        }
        
        @media (max-width: 480px) {
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .btn, .theme-toggle {
                flex: 1;
                justify-content: center;
                padding: 12px 16px;
                font-size: 0.85em;
            }
            .footer {
                padding: 16px;
                font-size: 0.75em;
            }
        }
        
        .footer {
            text-align: center;
            padding: 24px 20px;
            margin-top: 40px;
            color: var(--text-tertiary);
            font-size: 0.85em;
            border-top: 1px solid var(--border-color);
        }
        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        .footer-text {
            color: var(--text-secondary);
        }
        .footer-link {
            color: var(--accent-start);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .footer-link:hover {
            color: var(--accent-mid);
            text-decoration: underline;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease;
            position: relative;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            padding: 32px 40px 24px;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
            border-radius: 20px 20px 0 0;
        }
        .modal-title {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.9em;
            color: var(--text-tertiary);
        }
        .modal-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--hover-bg);
            border-radius: 8px;
        }
        .modal-body {
            padding: 32px 40px;
        }
        .modal-section {
            margin-bottom: 28px;
        }
        .modal-section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-section-content {
            color: var(--text-secondary);
            line-height: 1.7;
            padding: 16px;
            background: var(--hover-bg);
            border-radius: 12px;
            border-left: 4px solid var(--accent-start);
        }
        .modal-list {
            list-style: none;
            padding: 0;
        }
        .modal-list li {
            padding: 10px 16px;
            margin-bottom: 8px;
            background: var(--hover-bg);
            border-radius: 8px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        .modal-list li::before {
            content: '‚ñ∏';
            color: var(--accent-start);
            font-weight: bold;
            flex-shrink: 0;
        }
        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
            transform: rotate(90deg);
        }
        .entry {
            cursor: pointer;
        }
        
        /* Token Statistics Styles */
        .stats-card {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 20px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 32px;
            font-size: 1.5em;
            font-weight: 800;
            color: var(--text-primary);
        }
        .stats-header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .collapse-all-btn {
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.5em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .collapse-all-btn:hover {
            background: var(--accent-start);
            color: white;
            border-color: var(--accent-start);
        }
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }
        .stat-item {
            background: var(--hover-bg);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-start);
            transition: all 0.3s ease;
        }
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-label {
            font-size: 0.85em;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }
        .stat-subtext {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        .progress-bar-container {
            background: var(--hover-bg);
            border-radius: 12px;
            height: 40px;
            overflow: hidden;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 16px;
            color: white;
            font-weight: 700;
            font-size: 0.9em;
        }
        .progress-bar.warning {
            background: linear-gradient(90deg, var(--warning) 0%, #f59e0b 100%);
        }
        .progress-bar.error {
            background: linear-gradient(90deg, var(--error) 0%, #dc2626 100%);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .stats-section {
            background: var(--hover-bg);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            margin-bottom: 48px;
        }
        .stats-section:last-child {
            margin-bottom: 0;
        }
        .stats-section:hover {
            box-shadow: var(--shadow-md);
        }
        .stats-section.collapsed .stats-section-content {
            display: none;
        }
        .stats-section.collapsed .stats-section-toggle {
            transform: rotate(-90deg);
        }
        .stats-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 16px;
        }
        .stats-section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-section-toggle {
            color: var(--text-tertiary);
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }
        .stats-section-content {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .agent-list, .skill-list, .file-list, .timeline-list {
            display: grid;
            gap: 8px;
        }
        .agent-item, .skill-item, .file-item, .timeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--card-bg);
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }
        .agent-item:hover, .skill-item:hover, .file-item:hover, .timeline-item:hover {
            background: var(--accent-start);
            color: white;
            transform: translateX(4px);
            border-color: var(--accent-start);
        }
        .agent-item:hover .agent-tokens, 
        .skill-item:hover .skill-tokens,
        .file-item:hover .file-tokens,
        .timeline-item:hover .timeline-tokens {
            color: white;
        }
        .agent-name, .skill-name, .file-name, .timeline-date {
            font-weight: 600;
            font-size: 0.95em;
        }
        .agent-tokens, .skill-tokens, .file-tokens, .timeline-tokens {
            font-size: 0.9em;
            color: var(--text-tertiary);
            font-weight: 600;
        }
        .cleanup-status {
            padding: 16px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        .cleanup-status.healthy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }
        .cleanup-status.review {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 2px solid var(--warning);
        }
        .cleanup-status.cleanup {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 2px solid var(--error);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><span class="logo">üíæ</span>BetterAgents Memory Dashboard</h1>
                <p class="subtitle">JSON memory system - Visualize, filter and manage your persistent memory</p>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()"><span id="themeIcon">üåô</span></button>
                <button class="btn btn-refresh" onclick="reloadMemory()"><span>üîÑ</span></button>
            </div>
        </div>
        <div class="search-container">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search" id="searchInput" placeholder="Search in memory..." onkeyup="filterEntries()" oninput="toggleClearButton()">
                <button class="search-clear" id="searchClear" onclick="clearSearch()" title="Clear search">‚úï</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')" data-tab="all">
                    <span>üîµ</span>
                    <span>All</span>
                    <span class="tab-badge" id="badgeAll">0</span>
                </button>
                <button class="tab" onclick="switchTab('decisions')" data-tab="decisions">
                    <span>üìù</span>
                    <span>Decisions</span>
                    <span class="tab-badge" id="badgeDecisions">0</span>
                </button>
                <button class="tab" onclick="switchTab('tasks')" data-tab="tasks">
                    <span>‚úÖ</span>
                    <span>Tasks</span>
                    <span class="tab-badge" id="badgeTasks">0</span>
                </button>
                <button class="tab" onclick="switchTab('patterns')" data-tab="patterns">
                    <span>üß©</span>
                    <span>Patterns</span>
                    <span class="tab-badge" id="badgePatterns">0</span>
                </button>
                <button class="tab" onclick="switchTab('context')" data-tab="context">
                    <span>üéØ</span>
                    <span>Context</span>
                </button>
                <button class="tab" onclick="switchTab('tokens')" data-tab="tokens">
                    <span>üìä</span>
                    <span>Tokens</span>
                </button>
                <button class="tab" onclick="switchTab('metrics')" data-tab="metrics">
                    <span>üìà</span>
                    <span>Metrics</span>
                </button>
            </div>
        </div>
        
        <!-- Token Statistics Section -->
        <div class="stats-card" id="tokenStats" style="display: none;">
            <div class="stats-header">
                <span>ÔøΩ</span>
                <span>Memory Statistics</span>
            </div>
            
            <div class="stats-overview">
                <div class="stat-item">
                    <div class="stat-label">Total Memory</div>
                    <div class="stat-value" id="totalTokens">0</div>
                    <div class="stat-subtext">tokens</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Input Tokens</div>
                    <div class="stat-value" id="inputTokens">0</div>
                    <div class="stat-subtext">tokens read</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Output Tokens</div>
                    <div class="stat-value" id="outputTokens">0</div>
                    <div class="stat-subtext">tokens written</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Entries</div>
                    <div class="stat-value" id="totalEntries">0</div>
                    <div class="stat-subtext">across all categories</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Average Size</div>
                    <div class="stat-value" id="avgTokens">0</div>
                    <div class="stat-subtext">tokens per entry</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Threshold</div>
                    <div class="stat-value" id="percentUsed">0%</div>
                    <div class="stat-subtext">of 50K limit</div>
                </div>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">üìù By Category</div>
                <div class="stats-overview">
                    <div class="stat-item">
                        <div class="stat-label">Decisions</div>
                        <div class="stat-value" id="decisionTokens">0</div>
                        <div class="stat-subtext">tokens</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Tasks</div>
                        <div class="stat-value" id="taskTokens">0</div>
                        <div class="stat-subtext">tokens</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Patterns</div>
                        <div class="stat-value" id="patternTokens">0</div>
                        <div class="stat-subtext">tokens</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">üë§ By Agent</div>
                <div class="agent-list" id="agentList"></div>
            </div>
            
            <div class="stats-section" id="skillSection" style="display: none;">
                <div class="stats-section-title">üìö By Skill</div>
                <div class="skill-list" id="skillList"></div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">üßπ Cleanup Status</div>
                <div class="cleanup-status healthy" id="cleanupStatus">
                    <span>‚úÖ</span>
                    <span>Healthy (0% used)</span>
                </div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">üìä Distribution</div>
                <div class="stats-overview">
                    <div class="stat-item">
                        <div class="stat-label">Smallest Entry</div>
                        <div class="stat-value" id="minTokens">0</div>
                        <div class="stat-subtext">tokens</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Largest Entry</div>
                        <div class="stat-value" id="maxTokens">0</div>
                        <div class="stat-subtext">tokens</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">üìÅ By File</div>
                <div class="agent-list" id="fileList"></div>
            </div>
            
            <div class="stats-section" id="timelineSection" style="display: none;">
                <div class="stats-section-title">üìà Recent Activity</div>
                <div id="timelineList"></div>
            </div>
        </div>
        
        <!-- Project Metrics Section -->
        <div class="stats-card" id="metricsCard" style="display: none;">
            <div class="stats-header">
                <span>üìà</span>
                <span>Project Metrics</span>
            </div>
            
            <div id="metricsContent" style="padding: 20px;">
                <div class="loading"><div class="spinner"></div><p>Loading metrics...</p></div>
            </div>
        </div>
        
        <div class="content">
            <h2 class="section-title"><span>üìã</span><span id="sectionTitle">Recent Activity</span></h2>
            <div id="entriesContainer"><div class="loading"><div class="spinner"></div><p>Loading memory...</p></div></div>
        </div>
        
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-text">
                    Developed by <a href="https://jemavi.co" target="_blank" rel="noopener noreferrer" class="footer-link">JEMAVI</a> | <span id="currentYear">2026</span>
                </div>
            </div>
        </footer>
        
        <!-- Modal -->
        <div id="detailModal" class="modal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle"></div>
                    <div class="modal-meta" id="modalMeta"></div>
                </div>
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>
    </div>
    <script>
        let memoryData = {
            decisions: [{"id":"DEC-001","date":"2026-02-16T07:39:43-05:00","title":"Use local timezone for dashboard timestamps","context":"Users need to see timestamps in their local timezone for better usability","decision":"Convert ISO timestamps to local browser timezone using JavaScript Date object","consequences":{"positive":["Better user experience","Accurate local time display","No server-side timezone handling needed"],"negative":["Time displayed varies by user location"],"risks":["None significant"]},"alternatives":["Keep UTC time (rejected: confusing for users)","Server-side conversion (rejected: adds complexity)"],"agent":"AgentX/Coder","tags":["timezone","ux","dashboard"]},{"id":"DEC-002","date":"2026-02-15T07:39:43-05:00","title":"Include seconds in timestamp display","context":"Need precise timing information for debugging and tracking","decision":"Display timestamps with seconds (HH:MM:SS) instead of just HH:MM","consequences":{"positive":["More precise timing","Better for debugging","Useful for tracking rapid changes"],"negative":["Slightly more visual clutter"],"risks":["None"]},"alternatives":["Keep HH:MM format (rejected: less precise)"],"agent":"AgentX/Coder","tags":["precision","timestamps","ui"]}],
            tasks: [{"id":"TASK-001","date":"2026-02-15","title":"BetterAgentX v2.1.0 published to GitHub","status":"completed","description":"Completed pre-push audit, fixed 3 blockers and 4 critical issues, cleaned memory files, and successfully pushed to https://github.com/jemavidev/BetterAgentX","agent":"AgentX/Multi-Agent","files_modified":["README.md","config/betteragents.json","config/agent-skills.json","scripts/verify-system.sh","changelog.md",".gitignore",".kiro/memory/*.json"],"outcome":"Project published with 95/100 consistency score. Ready for public use.","tags":["milestone","github","release","v2.1.0"]},{"id":"TASK-002","date":"2026-02-16","title":"Fixed update-skills.sh to use project-relative path","status":"completed","description":"Script was using $HOME/.kiro/skills (9 skills) instead of project .kiro/skills (56 skills). Updated to use project-relative path resolution.","agent":"AgentX/Tester","files_modified":["scripts/update-skills.sh"],"outcome":"Script now correctly identifies all 56 project skills","tags":["bug-fix","scripts","testing"]},{"id":"TASK-003","date":"2026-02-16","title":"Standardized all scripts to use project-relative paths","status":"completed","description":"Updated 5 scripts (update-skills.sh, memory-stats.sh, open-dashboard.sh, update-dashboard.sh, verify-system.sh) to use project-relative paths instead of hardcoded or current-directory paths.","agent":"AgentX/Tester","files_modified":["scripts/update-skills.sh","scripts/memory-stats.sh","scripts/open-dashboard.sh","scripts/update-dashboard.sh","scripts/verify-system.sh"],"outcome":"All scripts now work consistently from project directory using $PROJECT_ROOT variable","tags":["refactoring","scripts","paths","consistency"]},{"id":"TASK-004","date":"2026-02-16","title":"Fixed and optimized verify-system.sh script","status":"completed","description":"Corrected syntax errors, adjusted agent format detection to support both standard and orchestrator formats, fixed memory file counting, and improved skill recommendation counting logic.","agent":"AgentX/Tester","files_modified":["scripts/verify-system.sh"],"outcome":"Script now runs without errors, correctly validates all 13 agents, and reports system as fully functional","tags":["bug-fix","scripts","validation","testing"]},{"id":"TASK-005","date":"2026-02-16","title":"Added debug mode and troubleshooting guide to verify-system.sh","status":"completed","description":"Implemented --debug flag with verbose output, added debug() function for detailed logging, and created comprehensive troubleshooting documentation covering 8 common errors with solutions.","agent":"AgentX/Tester","files_modified":["scripts/verify-system.sh","docs/troubleshooting/verify-system-errors.md"],"outcome":"Script now has full debugging capabilities and comprehensive error documentation for easy troubleshooting","tags":["enhancement","debugging","documentation","troubleshooting"]},{"id":"TASK-006","date":"2026-02-16T15:45:30-05:00","title":"TEST: Dashboard date formatting with timestamp","status":"completed","description":"Testing that ISO timestamps display correctly with time in dashboard","agent":"AgentX/Coder","files_modified":["templates/memory/dashboard.html"],"outcome":"Verification of formatDate() function","tags":["test","dashboard","formatting"]},{"id":"TASK-007","date":"2026-02-16T07:39:22-05:00","title":"Improved dashboard date formatting to show local time","status":"completed","description":"Modified formatDate() to display timestamps in user local timezone with seconds","agent":"AgentX/Coder","files_modified":["templates/memory/dashboard.html"],"outcome":"Dashboard now shows accurate local time for all entries","tags":["dashboard","timezone","formatting"]},{"id":"TASK-008","date":"2026-02-16T05:39:22-05:00","title":"Code review and optimization of memory system","status":"completed","description":"Reviewed memory JSON structure and optimized data access patterns","agent":"AgentX/Coder","files_modified":[".kiro/memory/*.json"],"outcome":"Improved memory system performance","tags":["optimization","memory","review"]},{"id":"TASK-009","date":"2026-02-16T02:39:22-05:00","title":"Documentation update for dashboard usage","status":"in-progress","description":"Creating comprehensive guide for using the memory dashboard","agent":"AgentX/Writer","files_modified":["docs/memory/dashboard-usage.md"],"outcome":"In progress","tags":["documentation","dashboard","guide"]}],
            patterns: [{"id":"PAT-001","date":"2026-02-16","category":"implementation","problem":"Script using hardcoded $HOME/.kiro/skills instead of project-relative path","solution":"Use script location to derive project root, then reference .kiro/skills relatively","implementation":"SCRIPT_DIR=$(cd $(dirname ${BASH_SOURCE[0]}) && pwd); PROJECT_ROOT=$(cd $SCRIPT_DIR/.. && pwd); SKILLS_DIR=$PROJECT_ROOT/.kiro/skills","benefits":["Works from any location","Project-specific skills","No global dependency"],"when_to_use":"Scripts that need to reference project-relative directories","when_not_to_use":"When truly global configuration is needed","agent":"AgentX/Tester","tags":["bash","paths","bug-fix"]},{"id":"PAT-002","date":"2026-02-16T07:40:06-05:00","category":"frontend","problem":"Timestamps stored in UTC need to display in user local timezone","solution":"Use JavaScript Date object to automatically convert ISO timestamps to local timezone","implementation":"Parse ISO string with new Date(), then extract local hours/minutes/seconds using getHours(), getMinutes(), getSeconds()","benefits":["Automatic timezone conversion","No external libraries needed","Works across all timezones"],"when_to_use":"When displaying timestamps from server/storage to users","when_not_to_use":"When you need to keep UTC time visible","agent":"AgentX/Coder","tags":["timezone","javascript","datetime"]},{"id":"PAT-003","date":"2026-02-16T04:40:06-05:00","category":"testing","problem":"Need to verify date formatting works with various timestamp formats","solution":"Add test entries with different timestamp formats (ISO with timezone, ISO without, date only)","implementation":"Create test data with current time, past times, and date-only formats to verify all display correctly","benefits":["Validates formatting logic","Catches edge cases","Provides examples"],"when_to_use":"When implementing or modifying date/time display logic","when_not_to_use":"For production data","agent":"AgentX/Tester","tags":["testing","datetime","validation"]}],
            context: {"version":"1.0.0","lastUpdated":"","project":{"name":"","description":"","phase":"","startDate":""},"currentFocus":{"feature":"","objective":"","priority":"medium","estimatedCompletion":""},"techStack":{"languages":[],"frameworks":[],"databases":[],"tools":[]},"team":{"size":0,"roles":[],"activeAgents":[]},"constraints":{"timeline":"","budget":"","technical":[],"business":[]},"nextSteps":[],"blockers":[],"notes":""},
            stats: null,
            lastUpdate: "2026-02-16T07:40:19-05:00",
            lastUpdateReadable: "2026-02-16 07:40:19"
        };
        let currentTab = 'all';
        let searchQuery = '';

        async function loadMemory() {
            // Si memoryData ya tiene datos (embebidos por el script), no hacer fetch
            if (memoryData.decisions.length > 0 || memoryData.tasks.length > 0 || memoryData.patterns.length > 0) {
                console.log('Using embedded memory data');
                updateStats();
                renderEntries();
                loadTokenStats();
                return;
            }

            // Si no hay datos embebidos, intentar cargar desde archivos JSON
            try {
                console.log('Loading memory files...');
                const [decisionsRes, tasksRes, patternsRes, contextRes] = await Promise.all([
                    fetch('decision-log.json').catch(e => {
                        console.warn('decision-log.json not found:', e);
                        return { ok: false };
                    }),
                    fetch('progress.json').catch(e => {
                        console.warn('progress.json not found:', e);
                        return { ok: false };
                    }),
                    fetch('patterns.json').catch(e => {
                        console.warn('patterns.json not found:', e);
                        return { ok: false };
                    }),
                    fetch('active-context.json').catch(e => {
                        console.warn('active-context.json not found:', e);
                        return { ok: false };
                    })
                ]);

                if (decisionsRes.ok) {
                    const decisionsData = await decisionsRes.json();
                    memoryData.decisions = decisionsData.decisions || [];
                    console.log('Loaded decisions:', memoryData.decisions.length);
                }

                if (tasksRes.ok) {
                    const tasksData = await tasksRes.json();
                    memoryData.tasks = tasksData.tasks || [];
                    console.log('Loaded tasks:', memoryData.tasks.length);
                }

                if (patternsRes.ok) {
                    const patternsData = await patternsRes.json();
                    memoryData.patterns = patternsData.patterns || [];
                    console.log('Loaded patterns:', memoryData.patterns.length);
                }

                if (contextRes.ok) {
                    memoryData.context = await contextRes.json();
                    console.log('Loaded context');
                }

                updateStats();
                renderEntries();
            } catch (error) {
                console.error('Error loading memory:', error);
                document.getElementById('entriesContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error loading memory</div>
                        <div class="empty-text">
                            Make sure JSON files exist in the same directory.<br>
                            Check browser console for more details.
                        </div>
                    </div>
                `;
            }
        }

        function updateStats() {
            const totalDecisions = memoryData.decisions.length;
            const totalTasks = memoryData.tasks.length;
            const totalPatterns = memoryData.patterns.length;
            const totalAll = totalDecisions + totalTasks + totalPatterns;

            document.getElementById('badgeDecisions').textContent = totalDecisions;
            document.getElementById('badgeTasks').textContent = totalTasks;
            document.getElementById('badgePatterns').textContent = totalPatterns;
            document.getElementById('badgeAll').textContent = totalAll;
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            let entries = [];

            if (currentTab === 'all' || currentTab === 'decisions') {
                entries = entries.concat(memoryData.decisions.map(d => ({
                    ...d,
                    type: 'decision',
                    icon: 'üìù'
                })));
            }

            if (currentTab === 'all' || currentTab === 'tasks') {
                entries = entries.concat(memoryData.tasks.map(t => ({
                    ...t,
                    type: 'task',
                    icon: '‚úÖ'
                })));
            }

            if (currentTab === 'all' || currentTab === 'patterns') {
                entries = entries.concat(memoryData.patterns.map(p => ({
                    ...p,
                    type: 'pattern',
                    icon: 'üß©'
                })));
            }

            if (currentTab === 'context') {
                renderContextCards();
                return;
            }

            if (searchQuery) {
                entries = entries.filter(entry => 
                    JSON.stringify(entry).toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            entries.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-title">No entries</div>
                        <div class="empty-text">
                            ${searchQuery ? 'No results found for your search' : 'No entries found in memory'}
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = entries.map(entry => {
                if (entry.type === 'decision') return renderDecision(entry);
                if (entry.type === 'task') return renderTask(entry);
                if (entry.type === 'pattern') return renderPattern(entry);
                if (entry.type === 'context-decision') return renderContextDecision(entry);
                if (entry.type === 'context-pattern') return renderContextPattern(entry);
                if (entry.type === 'context-task') return renderContextTask(entry);
                if (entry.type === 'context-project') return renderContextProject(entry);
                if (entry.type === 'context-current') return renderContextCurrent(entry);
            }).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'No date';
            
            // Si ya tiene formato ISO con hora, convertir a hora local
            if (dateStr.includes('T')) {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
            
            // Si es solo fecha, retornar tal cual
            return dateStr;
        }

        function renderDecision(d) {
            return `
                <div class="entry" onclick='openModal(${JSON.stringify(d).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${d.icon} Decision</span>
                        <span>üóìÔ∏è ${formatDate(d.date)}</span>
                        <span>üè∑Ô∏è ${d.id || 'No ID'}</span>
                        <span>üë§ ${d.agent || 'No agent'}</span>
                    </div>
                    <div class="entry-title">${d.title || 'No title'}</div>
                    <div class="entry-content">
                        <strong>Context:</strong> ${d.context || 'No context'}<br>
                        <strong>Decision:</strong> ${d.decision || 'No decision'}
                    </div>
                    ${d.tags ? `<div class="entry-tags">${d.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                </div>
            `;
        }

        function renderTask(t) {
            const statusColors = {
                'completed': '#10b981',
                'in-progress': '#3b82f6',
                'blocked': '#ef4444',
                'todo': '#6b7280'
            };
            const color = statusColors[t.status] || '#6b7280';

            return `
                <div class="entry" style="border-left-color: ${color}" onclick='openModal(${JSON.stringify(t).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${t.icon} Task</span>
                        <span>üóìÔ∏è ${formatDate(t.date)}</span>
                        <span>üè∑Ô∏è ${t.id || 'No ID'}</span>
                        <span>üë§ ${t.agent || 'No agent'}</span>
                        <span style="color: ${color}">‚ö° ${t.status || 'No status'}</span>
                    </div>
                    <div class="entry-title">${t.title || 'No title'}</div>
                    <div class="entry-content">${t.description || 'No description'}</div>
                    ${t.tags ? `<div class="entry-tags">${t.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                </div>
            `;
        }

        function renderPattern(p) {
            return `
                <div class="entry" onclick='openModal(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${p.icon} Pattern</span>
                        <span>üóìÔ∏è ${formatDate(p.date)}</span>
                        <span>üè∑Ô∏è ${p.id || 'No ID'}</span>
                        <span>üë§ ${p.agent || 'No agent'}</span>
                        <span>üìÇ ${p.category || 'No category'}</span>
                    </div>
                    <div class="entry-title">${p.name || p.title || 'No name'}</div>
                    <div class="entry-content">
                        <strong>Problem:</strong> ${p.problem || 'No problem'}<br>
                        <strong>Solution:</strong> ${p.solution || 'No solution'}
                    </div>
                    ${p.tags ? `<div class="entry-tags">${p.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                </div>
            `;
        }

        function renderContextDecision(d) {
            const impactColors = {
                'high': '#ef4444',
                'medium': '#f59e0b',
                'low': '#10b981'
            };
            const color = impactColors[d.impact] || '#6b7280';
            
            return `
                <div class="entry" style="border-left-color: ${color}" onclick='openModal(${JSON.stringify(d).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${d.icon} Recent Decision</span>
                        <span>üè∑Ô∏è ${d.id || 'No ID'}</span>
                        <span style="color: ${color}">‚ö° Impact: ${d.impact || 'unknown'}</span>
                    </div>
                    <div class="entry-title">${d.title || 'No title'}</div>
                    <div class="entry-content">Referenced in active context</div>
                </div>
            `;
        }

        function renderContextPattern(p) {
            return `
                <div class="entry" onclick='openModal(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${p.icon} Active Pattern</span>
                        <span>üóìÔ∏è ${formatDate(p.date)}</span>
                        <span>üè∑Ô∏è ${p.id || 'No ID'}</span>
                        <span>üìä Used ${p.usageCount || 0} times</span>
                    </div>
                    <div class="entry-title">${p.title || 'No title'}</div>
                    <div class="entry-content">Currently active in project context</div>
                </div>
            `;
        }

        function renderContextCompleted(t) {
            return `
                <div class="entry" style="border-left-color: #10b981" onclick='openModal(${JSON.stringify(t).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${t.icon} Recently Completed</span>
                        <span>üóìÔ∏è ${formatDate(t.date)}</span>
                        <span>üè∑Ô∏è ${t.id || 'No ID'}</span>
                    </div>
                    <div class="entry-title">${t.title || 'No title'}</div>
                    <div class="entry-content">Completed recently</div>
                </div>
            `;
        }

        function renderContextProject(p) {
            return `
                <div class="entry" style="border-left-color: #3b82f6" onclick='openModal(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${p.icon} Project Overview</span>
                        ${p.startDate ? `<span>üóìÔ∏è Started: ${formatDate(p.startDate)}</span>` : ''}
                        ${p.status ? `<span>‚ö° ${p.status}</span>` : ''}
                    </div>
                    <div class="entry-title">${p.name || 'Project Information'}</div>
                    <div class="entry-content">
                        ${p.description ? `<strong>Description:</strong> ${p.description}<br>` : ''}
                        ${p.phase ? `<strong>Phase:</strong> ${p.phase}` : ''}
                    </div>
                </div>
            `;
        }

        function renderContextCurrent(c) {
            return `
                <div class="entry" style="border-left-color: #f59e0b" onclick='openModal(${JSON.stringify(c).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${c.icon} Current Focus</span>
                        ${c.blockers?.length > 0 ? `<span style="color: #ef4444">‚ö†Ô∏è ${c.blockers.length} Blockers</span>` : ''}
                    </div>
                    <div class="entry-title">${c.focus || 'Current Focus'}</div>
                    <div class="entry-content">
                        ${c.nextSteps?.length > 0 ? `<strong>Next Steps:</strong> ${c.nextSteps.length} items` : 'No next steps defined'}
                    </div>
                </div>
            `;
        }

        function renderContextCards() {
            const container = document.getElementById('entriesContainer');
            const ctx = memoryData.context;
            
            const projectCount = ctx.project?.name ? 1 : 0;
            const currentCount = ctx.currentFocus?.feature ? 1 : 0;
            const decisionsCount = ctx.context?.recentDecisions?.length || 0;
            const patternsCount = ctx.context?.activePatterns?.length || 0;
            const tasksCount = ctx.context?.openTasks?.length || 0;
            
            let html = '';
            
            // Project entry
            html += `
                <div class="entry" style="border-left-color: #3b82f6" onclick="openContextModal('project')">
                    <div class="entry-header">
                        <span>üè¢ Project Overview</span>
                        ${ctx.project?.startDate ? `<span>üóìÔ∏è Started: ${formatDate(ctx.project.startDate)}</span>` : ''}
                        ${ctx.project?.status ? `<span>‚ö° ${ctx.project.status}</span>` : ''}
                    </div>
                    <div class="entry-title">${ctx.project?.name || 'Project Information'}</div>
                    <div class="entry-content">
                        ${ctx.project?.description || 'No project description available'}
                        ${ctx.project?.phase ? `<br><strong>Phase:</strong> ${ctx.project.phase}` : ''}
                    </div>
                </div>
            `;
            
            // Current Focus entry
            html += `
                <div class="entry" style="border-left-color: #f59e0b" onclick="openContextModal('current')">
                    <div class="entry-header">
                        <span>üéØ Current Focus</span>
                        ${ctx.blockers?.length > 0 ? `<span style="color: #ef4444">‚ö†Ô∏è ${ctx.blockers.length} Blockers</span>` : '<span style="color: #10b981">‚úÖ No Blockers</span>'}
                        ${ctx.nextSteps?.length > 0 ? `<span>üìã ${ctx.nextSteps.length} Next Steps</span>` : ''}
                    </div>
                    <div class="entry-title">${ctx.currentFocus?.feature || 'Current Focus'}</div>
                    <div class="entry-content">
                        ${ctx.currentFocus?.objective || 'No current focus defined'}
                    </div>
                </div>
            `;
            
            // Recent Decisions entry
            html += `
                <div class="entry" style="border-left-color: #8b5cf6" onclick="openContextModal('decisions')">
                    <div class="entry-header">
                        <span>üìã Recent Decisions</span>
                        <span>üìä ${decisionsCount} decision${decisionsCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="entry-title">Recent Decisions</div>
                    <div class="entry-content">
                        ${decisionsCount > 0 ? `${decisionsCount} decision${decisionsCount !== 1 ? 's' : ''} referenced in active context` : 'No recent decisions'}
                    </div>
                </div>
            `;
            
            // Active Patterns entry
            html += `
                <div class="entry" style="border-left-color: #10b981" onclick="openContextModal('patterns')">
                    <div class="entry-header">
                        <span>üß© Active Patterns</span>
                        <span>üìä ${patternsCount} pattern${patternsCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="entry-title">Active Patterns</div>
                    <div class="entry-content">
                        ${patternsCount > 0 ? `${patternsCount} pattern${patternsCount !== 1 ? 's' : ''} currently active in project` : 'No active patterns'}
                    </div>
                </div>
            `;
            
            // Open Tasks entry
            html += `
                <div class="entry" style="border-left-color: #ef4444" onclick="openContextModal('tasks')">
                    <div class="entry-header">
                        <span>üìå Open Tasks</span>
                        <span>üìä ${tasksCount} task${tasksCount !== 1 ? 's' : ''}</span>
                        ${tasksCount > 0 ? '<span style="color: #ef4444">‚ö†Ô∏è Pending</span>' : '<span style="color: #10b981">‚úÖ Clear</span>'}
                    </div>
                    <div class="entry-title">Open Tasks</div>
                    <div class="entry-content">
                        ${tasksCount > 0 ? `${tasksCount} task${tasksCount !== 1 ? 's' : ''} currently open and pending` : 'No open tasks'}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function openContextModal(category) {
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMeta = document.getElementById('modalMeta');
            const modalBody = document.getElementById('modalBody');
            const ctx = memoryData.context;
            
            let titleHTML = '';
            let metaHTML = '';
            let bodyHTML = '';
            
            if (category === 'project') {
                titleHTML = 'üè¢ Project Overview';
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üìã Project Name</div>
                        <div class="modal-section-content">${ctx.project?.name || 'Not specified'}</div>
                    </div>
                `;
                if (ctx.project?.description) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üìù Description</div>
                            <div class="modal-section-content">${ctx.project.description}</div>
                        </div>
                    `;
                }
                if (ctx.project?.phase) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üîÑ Current Phase</div>
                            <div class="modal-section-content">${ctx.project.phase}</div>
                        </div>
                    `;
                }
                if (ctx.project?.status) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚ö° Status</div>
                            <div class="modal-section-content">${ctx.project.status}</div>
                        </div>
                    `;
                }
                if (ctx.project?.startDate) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üóìÔ∏è Start Date</div>
                            <div class="modal-section-content">${formatDate(ctx.project.startDate)}</div>
                        </div>
                    `;
                }
            } else if (category === 'current') {
                titleHTML = 'üéØ Current Focus';
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üéØ Feature</div>
                        <div class="modal-section-content">${ctx.currentFocus?.feature || 'No current focus defined'}</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">üìù Objective</div>
                        <div class="modal-section-content">${ctx.currentFocus?.objective || 'No objective defined'}</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">‚ö° Priority</div>
                        <div class="modal-section-content">${ctx.currentFocus?.priority || 'Not set'}</div>
                    </div>
                `;
                if (ctx.blockers && ctx.blockers.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚ö†Ô∏è Blockers</div>
                            <ul class="modal-list">
                                ${ctx.blockers.map(b => `<li>${typeof b === 'string' ? b : b.description || JSON.stringify(b)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚úÖ Blockers</div>
                            <div class="modal-section-content">No blockers</div>
                        </div>
                    `;
                }
                if (ctx.nextSteps && ctx.nextSteps.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üìã Next Steps</div>
                            <ul class="modal-list">
                                ${ctx.nextSteps.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            } else if (category === 'decisions') {
                titleHTML = 'üìã Recent Decisions';
                metaHTML = `<span>üìä ${ctx.context?.recentDecisions?.length || 0} decisions</span>`;
                if (ctx.context?.recentDecisions && ctx.context.recentDecisions.length > 0) {
                    bodyHTML = ctx.context.recentDecisions.map((d, index) => {
                        const fullDecision = memoryData.decisions.find(dec => dec.id === d.id);
                        if (!fullDecision) {
                            console.warn('Decision not found:', d.id);
                            return '';
                        }
                        return `
                        ${index > 0 ? '<div style="height: 16px"></div>' : ''}
                        <div class="modal-section" style="cursor: pointer; transition: all 0.3s; border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;" 
                             onmouseover="this.style.borderColor='var(--accent-start)'; this.style.transform='translateX(4px)'; this.style.boxShadow='var(--shadow-md)'" 
                             onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateX(0)'; this.style.boxShadow='none'"
                             onclick='closeModal(); setTimeout(() => openEntryModal("${d.id}"), 100)'>
                            <div class="modal-section-title" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">üìã</span>
                                <span>${d.id}: ${d.title}</span>
                            </div>
                            <div class="modal-section-content" style="margin-top: 8px;">
                                <strong>Impact:</strong> ${d.impact || 'Unknown'}
                            </div>
                        </div>
                    `}).filter(Boolean).join('');
                } else {
                    bodyHTML = `
                        <div class="modal-section">
                            <div class="modal-section-title">üìã No Decisions</div>
                            <div class="modal-section-content">No recent decisions found</div>
                        </div>
                    `;
                }
            } else if (category === 'patterns') {
                titleHTML = 'üß© Active Patterns';
                metaHTML = `<span>üìä ${ctx.context?.activePatterns?.length || 0} patterns</span>`;
                if (ctx.context?.activePatterns && ctx.context.activePatterns.length > 0) {
                    bodyHTML = ctx.context.activePatterns.map((p, index) => {
                        const fullPattern = memoryData.patterns.find(pat => pat.id === p.id);
                        return `
                        ${index > 0 ? '<div style="height: 16px"></div>' : ''}
                        <div class="modal-section" style="cursor: pointer; transition: all 0.3s; border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;" 
                             onmouseover="this.style.borderColor='var(--accent-start)'; this.style.transform='translateX(4px)'; this.style.boxShadow='var(--shadow-md)'" 
                             onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateX(0)'; this.style.boxShadow='none'"
                             onclick='closeModal(); setTimeout(() => openEntryModal("${p.id}"), 100)'>
                            <div class="modal-section-title" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">üß©</span>
                                <span>${p.id}: ${p.title}</span>
                            </div>
                            <div class="modal-section-content" style="margin-top: 8px;">
                                <strong>Usage Count:</strong> ${p.usageCount || 0} times
                            </div>
                        </div>
                    `}).join('');
                } else {
                    bodyHTML = `
                        <div class="modal-section">
                            <div class="modal-section-title">üß© No Patterns</div>
                            <div class="modal-section-content">No active patterns found</div>
                        </div>
                    `;
                }
            } else if (category === 'tasks') {
                titleHTML = 'üìå Open Tasks';
                metaHTML = `<span>üìä ${ctx.context?.openTasks?.length || 0} tasks</span>`;
                if (ctx.context?.openTasks && ctx.context.openTasks.length > 0) {
                    bodyHTML = ctx.context.openTasks.map((t, index) => {
                        const fullTask = memoryData.tasks.find(task => task.id === t.id);
                        return `
                        ${index > 0 ? '<div style="height: 16px"></div>' : ''}
                        <div class="modal-section" style="cursor: pointer; transition: all 0.3s; border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;" 
                             onmouseover="this.style.borderColor='var(--accent-start)'; this.style.transform='translateX(4px)'; this.style.boxShadow='var(--shadow-md)'" 
                             onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateX(0)'; this.style.boxShadow='none'"
                             onclick='closeModal(); setTimeout(() => openEntryModal("${t.id}"), 100)'>
                            <div class="modal-section-title" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">üìå</span>
                                <span>${t.id}: ${t.title}</span>
                            </div>
                            <div class="modal-section-content" style="margin-top: 8px;">
                                <strong>Status:</strong> ${t.status || 'Unknown'}
                            </div>
                        </div>
                    `}).join('');
                } else {
                    bodyHTML = `
                        <div class="modal-section">
                            <div class="modal-section-title">üìå No Tasks</div>
                            <div class="modal-section-content">No open tasks found</div>
                        </div>
                    `;
                }
            }
            
            modalTitle.innerHTML = titleHTML;
            modalMeta.innerHTML = metaHTML;
            modalBody.innerHTML = bodyHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function renderContextTask(t) {
            const statusColors = {
                'in-progress': '#3b82f6',
                'blocked': '#ef4444',
                'todo': '#f59e0b'
            };
            const color = statusColors[t.status] || '#6b7280';
            
            return `
                <div class="entry" style="border-left-color: ${color}" onclick='openModal(${JSON.stringify(t).replace(/'/g, "&apos;")})'>
                    <div class="entry-header">
                        <span>${t.icon} Open Task</span>
                        <span>üè∑Ô∏è ${t.id || 'No ID'}</span>
                        <span style="color: ${color}">‚ö° ${t.status || 'unknown'}</span>
                    </div>
                    <div class="entry-title">${t.title || 'No title'}</div>
                    <div class="entry-content">Currently open in project</div>
                </div>
            `;
        }



        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            const titles = {
                'all': 'Recent Activity',
                'decisions': 'Technical Decisions',
                'tasks': 'Tasks and Progress',
                'patterns': 'Reusable Patterns',
                'context': 'Project Context',
                'tokens': 'Token Statistics',
                'metrics': 'Project Metrics'
            };
            document.getElementById('sectionTitle').textContent = titles[tab];
            
            // Show/hide token stats card and content based on tab
            const tokenStats = document.getElementById('tokenStats');
            const metricsCard = document.getElementById('metricsCard');
            const content = document.querySelector('.content');
            
            if (tab === 'tokens') {
                tokenStats.style.display = 'block';
                if (metricsCard) metricsCard.style.display = 'none';
                content.style.display = 'none';
            } else if (tab === 'metrics') {
                tokenStats.style.display = 'none';
                if (metricsCard) metricsCard.style.display = 'block';
                content.style.display = 'none';
                loadProjectMetrics(); // Load metrics when tab is activated
            } else {
                tokenStats.style.display = 'none';
                if (metricsCard) metricsCard.style.display = 'none';
                content.style.display = 'block';
                renderEntries();
            }
        }

        function filterEntries() {
            searchQuery = document.getElementById('searchInput').value;
            toggleClearButton();
            renderEntries();
        }

        function toggleClearButton() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('searchClear');
            if (searchInput.value.length > 0) {
                clearButton.classList.add('visible');
            } else {
                clearButton.classList.remove('visible');
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            toggleClearButton();
            renderEntries();
        }

        function reloadMemory() {
            // Feedback visual
            const btn = document.querySelector('.btn-refresh');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span>';
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            
            // Forzar recarga sin cach√© despu√©s de breve delay
            setTimeout(() => {
                const timestamp = new Date().getTime();
                window.location.href = window.location.pathname + '?t=' + timestamp;
            }, 200);
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Modal functions
        function openModal(entry) {
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMeta = document.getElementById('modalMeta');
            const modalBody = document.getElementById('modalBody');

            // Set title
            modalTitle.innerHTML = `${entry.icon} ${entry.title || entry.name || 'Details'}`;

            // Set metadata
            let metaHTML = '';
            if (entry.date) metaHTML += `<span>üóìÔ∏è ${formatDate(entry.date)}</span>`;
            if (entry.id) metaHTML += `<span>üè∑Ô∏è ${entry.id}</span>`;
            if (entry.agent) metaHTML += `<span>üë§ ${entry.agent}</span>`;
            if (entry.status) metaHTML += `<span>‚ö° ${entry.status}</span>`;
            if (entry.category) metaHTML += `<span>üìÇ ${entry.category}</span>`;
            modalMeta.innerHTML = metaHTML;

            // Set body content based on type
            let bodyHTML = '';
            
            if (entry.type === 'decision') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üìã Context</div>
                        <div class="modal-section-content">${entry.context || 'No context provided'}</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">‚úÖ Decision</div>
                        <div class="modal-section-content">${entry.decision || 'No decision provided'}</div>
                    </div>
                `;
                
                if (entry.consequences) {
                    if (entry.consequences.positive && entry.consequences.positive.length > 0) {
                        bodyHTML += `
                            <div class="modal-section">
                                <div class="modal-section-title">‚ûï Positive Consequences</div>
                                <ul class="modal-list">
                                    ${entry.consequences.positive.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    if (entry.consequences.negative && entry.consequences.negative.length > 0) {
                        bodyHTML += `
                            <div class="modal-section">
                                <div class="modal-section-title">‚ûñ Negative Consequences</div>
                                <ul class="modal-list">
                                    ${entry.consequences.negative.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    if (entry.consequences.risks && entry.consequences.risks.length > 0) {
                        bodyHTML += `
                            <div class="modal-section">
                                <div class="modal-section-title">‚ö†Ô∏è Risks</div>
                                <ul class="modal-list">
                                    ${entry.consequences.risks.map(r => `<li>${r}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                }
                
                if (entry.alternatives && entry.alternatives.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üîÑ Alternatives Considered</div>
                            <ul class="modal-list">
                                ${entry.alternatives.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            } else if (entry.type === 'task') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üìù Description</div>
                        <div class="modal-section-content">${entry.description || 'No description provided'}</div>
                    </div>
                `;
                
                if (entry.outcome) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üéØ Outcome</div>
                            <div class="modal-section-content">${entry.outcome}</div>
                        </div>
                    `;
                }
                
                if (entry.files_modified && entry.files_modified.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üìÅ Files Modified</div>
                            <ul class="modal-list">
                                ${entry.files_modified.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            } else if (entry.type === 'pattern') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">‚ùì Problem</div>
                        <div class="modal-section-content">${entry.problem || 'No problem described'}</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">üí° Solution</div>
                        <div class="modal-section-content">${entry.solution || 'No solution provided'}</div>
                    </div>
                `;
                
                if (entry.implementation) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üîß Implementation</div>
                            <div class="modal-section-content">${entry.implementation}</div>
                        </div>
                    `;
                }
                
                if (entry.benefits && entry.benefits.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚ú® Benefits</div>
                            <ul class="modal-list">
                                ${entry.benefits.map(b => `<li>${b}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (entry.when_to_use) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚úÖ When to Use</div>
                            <div class="modal-section-content">${entry.when_to_use}</div>
                        </div>
                    `;
                }
                
                if (entry.when_not_to_use) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚ùå When NOT to Use</div>
                            <div class="modal-section-content">${entry.when_not_to_use}</div>
                        </div>
                    `;
                }
            } else if (entry.type === 'context-decision') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üìã Decision Reference</div>
                        <div class="modal-section-content">This decision is referenced in the active project context.</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">‚ö° Impact Level</div>
                        <div class="modal-section-content">${entry.impact || 'Unknown'}</div>
                    </div>
                `;
            } else if (entry.type === 'context-pattern') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üß© Active Pattern</div>
                        <div class="modal-section-content">This pattern is currently active in the project context.</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">üìä Usage Statistics</div>
                        <div class="modal-section-content">Used ${entry.usageCount || 0} times in this project</div>
                    </div>
                `;
                if (entry.lastUsed) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üóìÔ∏è Last Used</div>
                            <div class="modal-section-content">${formatDate(entry.lastUsed)}</div>
                        </div>
                    `;
                }
            } else if (entry.type === 'context-completed') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">‚úÖ Recently Completed</div>
                        <div class="modal-section-content">This task was recently completed and is tracked in the active context.</div>
                    </div>
                `;
            } else if (entry.type === 'context-task') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üìå Open Task</div>
                        <div class="modal-section-content">This task is currently open in the project.</div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">‚ö° Status</div>
                        <div class="modal-section-content">${entry.status || 'Unknown'}</div>
                    </div>
                `;
            } else if (entry.type === 'context-project') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üìã Project Name</div>
                        <div class="modal-section-content">${entry.name || 'Not specified'}</div>
                    </div>
                `;
                if (entry.description) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üìù Description</div>
                            <div class="modal-section-content">${entry.description}</div>
                        </div>
                    `;
                }
                if (entry.phase) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üîÑ Current Phase</div>
                            <div class="modal-section-content">${entry.phase}</div>
                        </div>
                    `;
                }
                if (entry.status) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚ö° Status</div>
                            <div class="modal-section-content">${entry.status}</div>
                        </div>
                    `;
                }
                if (entry.startDate) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üóìÔ∏è Start Date</div>
                            <div class="modal-section-content">${formatDate(entry.startDate)}</div>
                        </div>
                    `;
                }
            } else if (entry.type === 'context-current') {
                bodyHTML = `
                    <div class="modal-section">
                        <div class="modal-section-title">üéØ Current Focus</div>
                        <div class="modal-section-content">${entry.focus || 'No current focus defined'}</div>
                    </div>
                `;
                if (entry.blockers && entry.blockers.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚ö†Ô∏è Blockers</div>
                            <ul class="modal-list">
                                ${entry.blockers.map(b => `<li>${typeof b === 'string' ? b : b.description || JSON.stringify(b)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">‚úÖ Blockers</div>
                            <div class="modal-section-content">No blockers</div>
                        </div>
                    `;
                }
                if (entry.nextSteps && entry.nextSteps.length > 0) {
                    bodyHTML += `
                        <div class="modal-section">
                            <div class="modal-section-title">üìã Next Steps</div>
                            <ul class="modal-list">
                                ${entry.nextSteps.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            // Add tags if present
            if (entry.tags && entry.tags.length > 0) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">üè∑Ô∏è Tags</div>
                        <div class="entry-tags">
                            ${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            modalBody.innerHTML = bodyHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (!event || event.target.id === 'detailModal' || event.target.classList.contains('modal-close')) {
                const modal = document.getElementById('detailModal');
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Open modal for entry from context tab
        function openEntryModal(entryId) {
            console.log('openEntryModal called with ID:', entryId);
            if (!entryId) {
                console.error('No entry ID provided to openEntryModal');
                return;
            }
            
            // Find the full entry in memoryData
            let entry = null;
            
            // Check decisions
            if (entryId.startsWith('DEC-')) {
                entry = memoryData.decisions.find(d => d.id === entryId);
                if (entry) {
                    entry.type = 'decision';
                    entry.icon = 'üìã';
                }
            }
            // Check patterns
            else if (entryId.startsWith('PAT-')) {
                entry = memoryData.patterns.find(p => p.id === entryId);
                if (entry) {
                    entry.type = 'pattern';
                    entry.icon = 'üß©';
                }
            }
            // Check tasks
            else if (entryId.startsWith('TASK-')) {
                entry = memoryData.tasks.find(t => t.id === entryId);
                if (entry) {
                    entry.type = 'task';
                    entry.icon = 'üìå';
                }
            }
            
            if (!entry) {
                console.error('Entry not found:', entryId);
                return;
            }
            
            console.log('Found entry:', entry);
            // Call the main openModal function
            openModal(entry);
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Initialize
        initTheme();
        loadMemory();
        
        // Token Statistics Functions
        async function loadTokenStats() {
            if (memoryData.stats) {
                renderTokenStats(memoryData.stats);
                return;
            }
            
            try {
                const response = await fetch('memory-stats.json').catch(e => {
                    console.warn('memory-stats.json not found:', e);
                    return { ok: false };
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    memoryData.stats = stats;
                    renderTokenStats(stats);
                }
            } catch (error) {
                console.error('Error loading token stats:', error);
            }
        }
        
        // Project Metrics Functions
        async function loadProjectMetrics() {
            try {
                // Use embedded data instead of fetch
                if (memoryData.metrics && memoryData.metrics !== null) {
                    renderProjectMetrics(memoryData.metrics);
                } else {
                    document.getElementById('metricsContent').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No metrics data available. Run: bash scripts/update-project-metrics.sh</p>';
                }
            } catch (error) {
                console.error('Error loading project metrics:', error);
                document.getElementById('metricsContent').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Error loading metrics</p>';
            }
        }
        
        function renderProjectMetrics(metrics) {
            const projectTokens = (metrics.project?.totalTokens || 0).toLocaleString();
            const memoryTokens = (metrics.memory?.summary?.totalTokens || 0).toLocaleString();
            const llmTotal = (metrics.llm?.totals?.total || 0).toLocaleString();
            const llmInput = (metrics.llm?.totals?.input || 0).toLocaleString();
            const llmOutput = (metrics.llm?.totals?.output || 0).toLocaleString();
            const efficiency = ((metrics.efficiency?.memoryToProject || 0) * 100).toFixed(2);
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üì¶</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--accent-start);">${projectTokens}</div>
                        <div style="color: var(--text-secondary); margin-top: 5px;">Project Size</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">Total tokens</div>
                    </div>
                    
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üíæ</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--accent-start);">${memoryTokens}</div>
                        <div style="color: var(--text-secondary); margin-top: 5px;">Memory Size</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">Documented knowledge</div>
                    </div>
                    
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üî¢</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--accent-start);">${llmTotal}</div>
                        <div style="color: var(--text-secondary); margin-top: 5px;">LLM Consumed</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">Total usage</div>
                    </div>
                    
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">‚ö°</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--accent-start);">${efficiency}%</div>
                        <div style="color: var(--text-secondary); margin-top: 5px;">Efficiency</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">Memory/Project ratio</div>
                    </div>
                </div>
                
                <div style="padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--text-primary);">üìä Breakdown</h3>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                            <span>Project Size:</span>
                            <span style="font-weight: bold;">${projectTokens} tokens</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                            <span>Memory Documentation:</span>
                            <span style="font-weight: bold;">${memoryTokens} tokens</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                            <span>LLM Input:</span>
                            <span style="font-weight: bold;">${llmInput} tokens</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                            <span>LLM Output:</span>
                            <span style="font-weight: bold;">${llmOutput} tokens</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 1.5em;">üí°</span>
                        <h3 style="margin: 0; color: var(--text-primary);">Efficiency Insight</h3>
                    </div>
                    <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid var(--accent-start);">
                        <div style="font-size: 1em; color: var(--text-primary); margin-bottom: 8px;">
                            Memory captures <strong style="color: var(--accent-start);">${efficiency}%</strong> of project knowledge
                        </div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">
                            Target: >0.5% ‚Ä¢ Higher ratio indicates better knowledge retention
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('metricsContent').innerHTML = html;
        }
        
        // Toggle section collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }
        
        // Toggle all sections
        let allCollapsed = false;
        function toggleAllSections() {
            const sections = document.querySelectorAll('.stats-section');
            const btn = document.getElementById('collapseAllText');
            
            sections.forEach(section => {
                if (allCollapsed) {
                    section.classList.remove('collapsed');
                } else {
                    section.classList.add('collapsed');
                }
            });
            
            allCollapsed = !allCollapsed;
            btn.textContent = allCollapsed ? 'Expand All' : 'Collapse All';
        }
        
        function renderTokenStats(stats) {
            if (!stats || !stats.summary) return;
            
            const summary = stats.summary;
            const cleanup = stats.cleanupRecommendations;
            
            // Don't show stats card here - let switchTab control visibility
            
            // Update overview
            document.getElementById('totalTokens').textContent = summary.totalTokens.toLocaleString();
            document.getElementById('inputTokens').textContent = (summary.inputTokens || 0).toLocaleString();
            document.getElementById('outputTokens').textContent = (summary.outputTokens || 0).toLocaleString();
            document.getElementById('totalEntries').textContent = summary.totalEntries;
            document.getElementById('avgTokens').textContent = summary.avgTokensPerEntry;
            document.getElementById('percentUsed').textContent = cleanup.percentUsed + '%';
            
            // Update distribution
            if (summary.minTokens !== undefined) {
                document.getElementById('minTokens').textContent = summary.minTokens.toLocaleString();
            }
            if (summary.maxTokens !== undefined) {
                document.getElementById('maxTokens').textContent = summary.maxTokens.toLocaleString();
            }
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const percent = cleanup.percentUsed;
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            
            if (percent >= 75) {
                progressBar.classList.add('error');
            } else if (percent >= 50) {
                progressBar.classList.add('warning');
            }
            
            // Update category stats
            document.getElementById('decisionTokens').textContent = summary.byCategory.decisions.toLocaleString();
            document.getElementById('taskTokens').textContent = summary.byCategory.tasks.toLocaleString();
            document.getElementById('patternTokens').textContent = summary.byCategory.patterns.toLocaleString();
            
            // Update agent list
            const agentList = document.getElementById('agentList');
            const agents = Object.entries(summary.byAgent).sort((a, b) => b[1] - a[1]);
            agentList.innerHTML = agents.map(([agent, tokens]) => `
                <div class="agent-item">
                    <span class="agent-name">${agent}</span>
                    <span class="agent-tokens">${tokens.toLocaleString()} tokens</span>
                </div>
            `).join('');
            
            // Update file list
            if (stats.fileStats) {
                const fileList = document.getElementById('fileList');
                const files = Object.entries(stats.fileStats).sort((a, b) => b[1] - a[1]);
                fileList.innerHTML = files.map(([file, tokens]) => `
                    <div class="file-item">
                        <span class="file-name">${file}</span>
                        <span class="file-tokens">${tokens.toLocaleString()} tokens</span>
                    </div>
                `).join('');
            }
            
            // Update timeline
            if (stats.timeline && Object.keys(stats.timeline).length > 0) {
                document.getElementById('timelineSection').style.display = 'block';
                const timelineList = document.getElementById('timelineList');
                const timeline = Object.entries(stats.timeline).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 7);
                timelineList.innerHTML = timeline.map(([date, data]) => `
                    <div class="timeline-item">
                        <span class="timeline-date">${date}</span>
                        <span class="timeline-tokens">+${data.tokensAdded} tokens (${data.entriesAdded} entries)</span>
                    </div>
                `).join('');
            }
            
            // Update skill list if skills exist
            if (summary.bySkill && Object.keys(summary.bySkill).length > 0) {
                document.getElementById('skillSection').style.display = 'block';
                const skillList = document.getElementById('skillList');
                const skills = Object.entries(summary.bySkill).sort((a, b) => b[1] - a[1]);
                skillList.innerHTML = skills.map(([skill, tokens]) => `
                    <div class="skill-item">
                        <span class="skill-name">${skill}</span>
                        <span class="skill-tokens">${tokens.toLocaleString()} tokens</span>
                    </div>
                `).join('');
            }
            
            // Update cleanup status
            const cleanupStatus = document.getElementById('cleanupStatus');
            cleanupStatus.className = 'cleanup-status';
            
            if (cleanup.suggestedAction === 'cleanup') {
                cleanupStatus.classList.add('cleanup');
                cleanupStatus.innerHTML = '<span>üö®</span><span>Cleanup Needed (' + percent + '% used)</span>';
            } else if (cleanup.suggestedAction === 'review') {
                cleanupStatus.classList.add('review');
                cleanupStatus.innerHTML = '<span>‚ö†Ô∏è</span><span>Review Recommended (' + percent + '% used)</span>';
            } else {
                cleanupStatus.classList.add('healthy');
                cleanupStatus.innerHTML = '<span>‚úÖ</span><span>Healthy (' + percent + '% used)</span>';
            }
        }
        
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>
